{% extends 'base.html' %}

{% block extra_head %}
{% load static %}
<script src="{% static 'js/ol.js' %}"></script>
{% endblock %}

{% block content %}
<style>
 .ol-attribution {
   position: absolute;
   bottom: 10px;
   left: 10px;
   font-size: 12px;
   max-width: calc(100% - 20px);
 }
</style>
<h1>Active Drivers Map</h1>
{% load static %}
<div id="map" style="width: 800px; height: 600px;"></div>
<script type="text/javascript">
    var departure, arrival;
    // Create a vector source for the active drivers
    var drivers = new ol.source.Vector({
        url: '{% url "driverlist" %}',
        format: new ol.format.GeoJSON()
    });

    // Get the user's location using the Geolocation API
    navigator.geolocation.getCurrentPosition(function(position) {
        var userLocation = ol.proj.fromLonLat([position.coords.longitude, position.coords.latitude]);
        // Create a vector source for the user location
        var userLocationSource = new ol.source.Vector({
            features: [
                new ol.Feature({
                    geometry: new ol.geom.Point(userLocation)
                })
            ]
        });

        // Add the user location and driver markers to the map
        var map = new ol.Map({
            target: 'map',
           // controls: ol.control.defaults({ attribution: false }),
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                }),
                new ol.layer.Vector({
                    source: drivers,
                    // Define the style for the driver markers
                    style: new ol.style.Style({
                      image: new ol.style.Circle({
                        radius: 4,
                        fill: new ol.style.Fill({color: 'lightgreen'}),
                        stroke: new ol.style.Stroke({color: 'white', width: 2})
                      })
                    })
                }),
                new ol.layer.Vector({
                    source: userLocationSource,
                    // Define the style for the user location marker
                    style: new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: 6,
                            fill: new ol.style.Fill({color: 'blue'}),
                            stroke: new ol.style.Stroke({color: 'white', width: 2})
                        })
                    })
                })
            ],
            view: new ol.View({
                center: userLocation,
                zoom: 10
            })
        });
        // Handle the click event on the map to set the departure and arrival points
        {% if is_customer %}
          // Declare default marker style
          var defaultStyle = new ol.style.Style({
            image: new ol.style.Circle({
              radius: 6,
              fill: new ol.style.Fill({color: 'white'}),
              stroke: new ol.style.Stroke({color: 'black', width: 2})
            })
          });

          // Initialize variables
          var departure = null;
          var arrival = null;
          var departureFeature = null;
          var arrivalFeature = null;
          var vectorSource = new ol.source.Vector();
          var vectorLayer = new ol.layer.Vector({
            source: vectorSource
          });
          map.addLayer(vectorLayer);

          // Add click handler
          map.on('singleclick', function(event) {
            var coordinate = event.coordinate;
            var lonLat = ol.proj.toLonLat(coordinate);
            var feature = new ol.Feature({
              geometry: new ol.geom.Point(coordinate)
            });
            if (!departure) {
              departure = lonLat;
              departureFeature = feature;
              departureFeature.setStyle(new ol.style.Style({
                image: new ol.style.Circle({
                  radius: 6,
                  fill: new ol.style.Fill({color: 'white'}),
                  stroke: new ol.style.Stroke({color: 'green', width: 2})
                })
              }));
              vectorSource.addFeature(departureFeature);
            } else if (!arrival) {
              arrival = lonLat;
              arrivalFeature = feature;
              arrivalFeature.setStyle(new ol.style.Style({
                image: new ol.style.Circle({
                  radius: 6,
                  fill: new ol.style.Fill({color: 'white'}),
                  stroke: new ol.style.Stroke({color: 'red', width: 2})
                })
              }));
              vectorSource.addFeature(arrivalFeature);
              // Add the confirm button
              var confirmBtn = document.getElementById('confirm-btn');
              confirmBtn.disabled = false;
              confirmBtn.addEventListener('click', function() {
                // Show pop-up to confirm selection
                let time = prompt("Confirm selection of departure: " + departure + " and arrival: " + arrival + "?\n\n" + "If correct, please enter a pick-up time.")
                if (time != "" && time != null) {
                  // Send coordinates to call_driver
                  window.location.href = "{% url 'call_driver' %}?departure=" + departure + "&arrival=" + arrival + "&time=" + time;
                } else {
                  // Unset variables and remove markers
                  departure = null;
                  arrival = null;
                  vectorSource.removeFeature(departureFeature);
                  vectorSource.removeFeature(arrivalFeature);
                  confirmBtn.disabled = true;
                }
              });
            }
          });
        {% endif %}
    });
</script>
{% if buttons %}
<div class="btn-group" role="group" aria-label="Basic example">
  {% for button in buttons %}
  <a href="{{ button.url }}" class="btn btn-primary" {% if button.disabled %}disabled{% endif %}>{{ button.label }}</a>
  {% endfor %}
</div>
{% else %}
<p>No buttons available</p>
{% endif %}
{% if is_customer %}
<button id="confirm-btn" class="btn btn-primary" disabled>Confirm Selection</button>
{% endif %}
{% endblock %}
